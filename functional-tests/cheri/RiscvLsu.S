#include "riscv_test.h"

#include "test_macros_cap.h"
#include "cheri.h"

RVTEST_RV32U
RVTEST_CODE_BEGIN

    INIT_ROOT_CAP

    li x28, BOUNDS_BASE
    
    TEST_CASE_DCC_BOUNDS_EXCEPTION(1, 0, CAUSE_LENGTH_VIOLATION, sb zero, (x28))
    TEST_CASE_DCC_BOUNDS_EXCEPTION(2, 1, CAUSE_LENGTH_VIOLATION, sh zero, (x28))
    TEST_CASE_DCC_BOUNDS_EXCEPTION(3, 3, CAUSE_LENGTH_VIOLATION, sw zero, (x28))
    TEST_CASE_DCC_BOUNDS_EXCEPTION(4, 0, CAUSE_LENGTH_VIOLATION, lb zero, (x28))
    TEST_CASE_DCC_BOUNDS_EXCEPTION(5, 1, CAUSE_LENGTH_VIOLATION, lh zero, (x28))
    TEST_CASE_DCC_BOUNDS_EXCEPTION(6, 3, CAUSE_LENGTH_VIOLATION, lw zero, (x28))

    TEST_CASE_DCC_BOUNDS_NO_EXCEPTION(7,  1, sb zero, (x28))
    TEST_CASE_DCC_BOUNDS_NO_EXCEPTION(8,  2, sh zero, (x28))
    TEST_CASE_DCC_BOUNDS_NO_EXCEPTION(9,  4, sw zero, (x28))
    TEST_CASE_DCC_BOUNDS_NO_EXCEPTION(10, 1, lb zero, (x28))
    TEST_CASE_DCC_BOUNDS_NO_EXCEPTION(11, 2, lh zero, (x28))
    TEST_CASE_DCC_BOUNDS_NO_EXCEPTION(12, 4, lw zero, (x28))

    TEST_CASE_DCC_AND_PERM_EXCEPTION(13, ~(1 << PERM_PERMIT_STORE), CAUSE_PERMIT_STORE_VIOLATION, sb zero, (x28))
    TEST_CASE_DCC_AND_PERM_EXCEPTION(14, ~(1 << PERM_PERMIT_LOAD),  CAUSE_PERMIT_LOAD_VIOLATION,  lb zero, (x28))

    TEST_CASE_DCC_AND_PERM_NO_EXCEPTION(15, ~(1 << PERM_PERMIT_STORE), lb zero, (x28))
    TEST_CASE_DCC_AND_PERM_NO_EXCEPTION(16, ~(1 << PERM_PERMIT_LOAD),  sb zero, (x28))

    TEST_CASE_FREE(17)
        SET_BOUNDS_DCC(512)
        SEAL_DDC(12)
        EXPECT_EXCEPTION(CAUSE_SEAL_VIOLATION, CAP_IDX_DDC, sb zero, (x28))

    TEST_PASSFAIL

RVTEST_CODE_END

  .data
RVTEST_DATA_BEGIN

  TEST_DATA

RVTEST_DATA_END
